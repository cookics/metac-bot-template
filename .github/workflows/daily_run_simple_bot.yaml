name: Regularly forecast new questions

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *" # runs every 30 minutes. Make sure to skip already forecasted questions!

# Give the GITHUB_TOKEN permissions to update the repo content and run title
permissions:
  contents: write
  actions: write
  checks: write

jobs:
  daily_build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Fetch all history for all branches and tags
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true
      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}
      - name: Install dependencies
        run: poetry install --no-interaction --no-root
      - name: Fetch previous records from bot-data
        continue-on-error: true
        run: |
          git fetch origin bot-data:bot-data || echo "bot-data branch does not exist yet."
          git checkout bot-data -- spring-aib-2026/ minibench/ logs/ 2>/dev/null || echo "No previous data found on bot-data branch."
      - name: Run bot
        run: |
          poetry run python main.py
        env:
          METACULUS_TOKEN: ${{ secrets.METACULUS_TOKEN }}
          EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      - name: Job Summary
        if: always()
        run: |
          if [ -f logs/summary.md ]; then
            cat logs/summary.md >> $GITHUB_STEP_SUMMARY
          fi
      - name: Commit and Push Tournament Records
        if: always()
        run: |
          # 1. Store the results we want to keep in a temporary location outside the repo
          mkdir -p ../temp_bot_data
          cp -r logs spring-aib-2026 minibench ../temp_bot_data/ 2>/dev/null || true
          # Also copy any root-level markdown records (except README)
          for f in *.md; do [ "$f" != "README.md" ] && cp "$f" ../temp_bot_data/ 2>/dev/null || true; done
          
          # 2. Setup Git
          git config --global user.name "metaculus-bot[bot]"
          git config --global user.email "metaculus-bot@users.noreply.github.com"
          
          # 3. Switch to bot-data branch
          # We fetch first to ensure we know about the branch
          git fetch origin bot-data || echo "bot-data branch does not exist on remote."
          
          # Checkout bot-data if it exists, otherwise create it as an orphan
          if git branch -r | grep -q "origin/bot-data"; then
            git checkout bot-data
            git pull origin bot-data
          else
            git checkout --orphan bot-data
            git rm -rf . # Start fresh for the data-only branch
          fi
          
          # 4. Bring in the new data
          cp -r ../temp_bot_data/* .
          # Ensure we don't accidentally carry over the README from main if it's in the temp dir
          git reset README.md 2>/dev/null || true
          
          # 5. Commit and Push
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "ðŸ¤– Update tournament records and logs [skip ci]"
            git push origin bot-data
          else
            echo "No changes in records to commit."
          fi
