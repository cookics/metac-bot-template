name: Regularly forecast new questions

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *" # runs every 30 minutes. Make sure to skip already forecasted questions!

# Give the GITHUB_TOKEN permissions to update the repo content and run title
permissions:
  contents: write
  actions: write
  checks: write

jobs:
  daily_build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Fetch all history for all branches and tags
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true
      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}
      - name: Install dependencies
        run: poetry install --no-interaction --no-root
      - name: Run bot
        run: |
          poetry run python main.py
        env:
          METACULUS_TOKEN: ${{ secrets.METACULUS_TOKEN }}
          EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      - name: Commit and Push Tournament Records
        if: always()
        run: |
          git config --global user.name "metaculus-bot[bot]"
          git config --global user.email "metaculus-bot@users.noreply.github.com"
          
          # Stage changes. Using -f or checking existence properly.
          # We'll use git add on everything and let the diff handle it.
          # But to be safe with pathspecs:
          git add spring-aib-2026/ minibench/ logs/ 2>/dev/null || echo "Some directories missing, skipping those."
          
          # Only commit if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "ðŸ¤– Update tournament records and logs [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "No changes in records to commit."
          fi
      - name: Job Summary
        if: always()
        run: |
          if [ -f summary.md ]; then
            cat summary.md >> $GITHUB_STEP_SUMMARY
          fi
      - name: Set Job to Neutral if No Forecasts
        if: always()
        continue-on-error: true
        run: |
          if [ -f forecast_count.txt ]; then
            COUNT=$(cat forecast_count.txt)
            if [ "$COUNT" -eq 0 ]; then
              echo "No forecasts made, setting job to neutral status..."
              
              # Get the current job's check run ID
              JOB_ID=$(gh api /repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs \
                --jq '.jobs[] | select(.name == "daily_build") | .id')
              
              echo "Job ID: $JOB_ID"
              
              # Patch the check run to neutral
              gh api --method PATCH \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                /repos/${{ github.repository }}/check-runs/$JOB_ID \
                -f status="completed" \
                -f conclusion="neutral" \
                -F output[title]="No New Forecasts" \
                -F output[summary]="Bot checked questions but found nothing new to forecast."
              
              echo "Job conclusion set to neutral"
            else
              echo "Forecasts were made ($COUNT), keeping success status"
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}